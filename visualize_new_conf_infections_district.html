<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="BE" style="width:100%; height:600px;"></div>
<div id="FR" style="width:100%; height:600px;"></div>
<div id="GR" style="width:100%; height:600px;"></div>
<div id="SG" style="width:100%; height:600px;"></div>
<div id="SO" style="width:100%; height:600px;"></div>
<div id="VS" style="width:100%; height:600px;"></div>
<div id="ZH" style="width:100%; height:600px;"></div>

<script>

function fetchData(url, canton) {
 	Plotly.d3.csv(url,
		function(data){
			processData(data, canton)
		}
	);
};
	
function processData(rows, canton) {
	let weeks = [];
	let districts = [];
	let date_mode = false;

	for (let i = 0; i < rows.length; i++) {
		row = rows[i];
		let week = row['Week'];
		if (!week) {
			week = row['Date'];
			date_mode = true;
		}
		let week_index = weeks.indexOf(week);
		if (week_index === -1) {
			week_index = weeks.length;
			weeks.push(week);
		}

		let district = row['District'];
		let district_index = districts.indexOf(district);
		if (district_index === -1) {
			district_index = districts.length;
			districts.push(district);
		}
	}

	let new_conf_cases = [];
	new_conf_cases.length = districts.length;
	for (let i = 0; i < rows.length; i++) {
		row = rows[i];
		let week = row['Week'];
		if (!week) {
			week = row['Date'];
		}
		let week_index = weeks.indexOf(week);

		let district = row['District'];
		let district_index = districts.indexOf(district);

		if (!new_conf_cases[district_index]) {
			new_conf_cases[district_index] = [];
			new_conf_cases[district_index].size = weeks.size;
		}

		let new_conf_case = row['NewConfCases'];
		let population = row['Population'];
		let value = new_conf_case / population * 100000;
		new_conf_cases[district_index][week_index] = value;
	}

	if (date_mode && weeks.length > 14) {
		for (let i = 0; i < weeks.length; ++i) {
			for (let district = 0; district < districts.length; ++district) {
				let sum = 0;
				for (let day = 0; day < 7 && i + day < new_conf_cases[district].length; ++day) {
					sum += new_conf_cases[district][i + day];
				}
				new_conf_cases[district][i] = sum / 7;
				let days = Math.min(7, new_conf_cases[district].length - i - 1);
				new_conf_cases[district].splice(i + 1, days - 1);
			}
			weeks.splice(i + 1, 6);
		}
	}

	updatePlot(weeks, districts, new_conf_cases, canton);
}

function updatePlot(weeks, districts, new_conf_cases, canton){
	var data = [{
		type: 'heatmap',
		x: weeks,
		y: districts,
		z: new_conf_cases,
		hovertemplate: 'District %{y} week/date %{x}: <b>%{z:.2f}</b>',
		showlegend: false,
		name: '',
	},
	];

	layout = {
		title: 'District data ' + canton,
		yaxis: {
			fixedrange: true,
		},
		xaxis : {
			fixedrange: true,
		},
	};

	Plotly.newPlot(canton, data, layout);
};

fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_BE_bezirk.csv', 'BE');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_FR_bezirk.csv', 'FR');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_GR_bezirk.csv', 'GR');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_SG_bezirk.csv', 'SG');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_SO_bezirk.csv', 'SO');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_VS_bezirk.csv', 'VS');
fetchData('https://raw.githubusercontent.com/openZH/covid_19/master/fallzahlen_bezirke/fallzahlen_kanton_ZH_bezirk.csv', 'ZH');

</script>

</body>
</html>
