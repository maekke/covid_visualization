<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="openzh_covid19.js"></script>
</head>
<body>
<div id="plot" style="width:100%; height:600px;"></div>
<select id="canton-selector" />

<script>

var canton = "ZH";
const dataColumns = ['ncumul_conf', 'ncumul_deceased', 'current_hosp', 'current_isolated', 'current_quarantined'];

function addTrace(trace) {
	let plotDiv = document.getElementById("plot");
	Plotly.addTraces(plotDiv, trace);
}

function makeplot() {
 	Plotly.d3.csv("https://raw.githubusercontent.com/maekke/bag_data/master/daten_pro_kanton/bag_data_" + canton + ".csv",
		function(data){
			processData(data)
		}
	);
}

function processData(rows) {
	let weeks = [];
	let total_pcr_tests = [];
	let positivity_rate = [];

	for (let i = 0; i < rows.length; ++i) {
		row = rows[i];
		if (row['total_number_of_tests'] > 0) {
			weeks.push(row['week']);
			total_pcr_tests.push(row['total_number_of_tests']);
			positivity_rate.push(row['positivity_rate_percent']);
		}
	}

	var traces = [{
		x: weeks,
		y: total_pcr_tests,
		name: 'PCR tests ' + canton,
	},
	{
		x: weeks,
		y: positivity_rate,
		name: 'Positivity rate ' + canton,
		yaxis: 'y2',
	},
	];

	addTrace(traces);
}



function makePlotly(){
	let cantons = getCantons();
	var cantonSelector = document.getElementById("canton-selector");
	for (let i = 0; i < cantons.length; ++i) {
		var option = document.createElement('option');
		option.text = cantons[i];
		cantonSelector.appendChild(option);
	}
	cantonSelector.value = canton;

	cantonSelector.addEventListener('change', function() {
		let plotDiv = document.getElementById("plot");
		for (let i = 0; i < 2; ++i) {
			Plotly.deleteTraces(plotDiv, 0);
		}
		canton = cantonSelector.value;
		makeplot();
	}, false);

	var traces = [];

	var layout = {
		title: 'PCR test - cantonal data',
		yaxis2: {
			title: 'Positivity rate %',
			overlaying: 'y',
			side: 'right',
			showgrid: false,
		},
	};

	Plotly.newPlot('plot', traces, layout);
}

makePlotly();
makeplot();

</script>

</body>
</html>
