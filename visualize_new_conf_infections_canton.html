<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="openzh_covid19.js"></script>
</head>
<body>
<div id="overview" style="width:100%; height:800px;"></div>
<div id="reduced" style="width:100%; height:800px;"></div>

<script>

function fetchData() {
 	Plotly.d3.csv('https://raw.githubusercontent.com/openZH/covid_19/master/COVID19_Fallzahlen_CH_total_v2.csv',
		function(data){
			processData(data)
		}
	);
};
	
function processData(rows) {
	let cantons = getCantons();
	const inhabitants = getCantonInhabitants();

	getOpenZhCovid19Data(['ncumul_conf'], function(dates, data, data_column_name) {
		// switch array index
		let total_conf_cases = [];
		total_conf_cases.size = cantons.length;
		for (let c = 0; c < cantons.length; ++c) {
			total_conf_cases[c] = []
			total_conf_cases[c].length = data.length;
			for (let d = 0; d < data.length; ++d) {
				total_conf_cases[c][d] = data[d][c];
			}
		}

		// create the difference
		let conf_cases_diff = [];
		conf_cases_diff.size = total_conf_cases.size;
		for (let canton = 0; canton < cantons.length; ++canton) {
			conf_cases_diff[canton] = [0];
			conf_cases_diff[canton].size = total_conf_cases[canton].size;
			for (let i = 1; i < dates.length; ++i) {
				conf_cases_diff[canton][i] = total_conf_cases[canton][i] - total_conf_cases[canton][i - 1]
			}
		}

		// keep a clone of the data for a subset
		let dates_from_june = dates.slice();
		let conf_cases_diff_from_june = JSON.parse(JSON.stringify(conf_cases_diff));

		// average the full set and plot it
		average_canton_data(dates, cantons, conf_cases_diff, 7, inhabitants);
		updatePlot(dates, cantons, conf_cases_diff, 'overview');

		// create a second plot from beginning of june
		let index = dates_from_june.indexOf('2020-06-01')
		if (index === -1) {
			console.log('could not find 2020-06-01 entry!')
			return;
		}
		// and remove everything before 2020-06-01.
		for (let canton = 0; canton < cantons.length; ++canton) {
			conf_cases_diff_from_june[canton].splice(0, index);
		}
		dates_from_june.splice(0, index);
		// and average / output it.
		average_canton_data(dates_from_june, cantons, conf_cases_diff_from_june, 7, inhabitants);
		updatePlot(dates_from_june, cantons, conf_cases_diff_from_june, 'reduced');
	});
}

function average_canton_data(dates, cantons, conf_cases_diff, avg_days, inhabitants) {
	for (let i = 0; i < dates.length; ++i) {
		for (let canton = 0; canton < cantons.length; ++canton) {
			let sum = 0;
			for (let day = 0; day < avg_days && i + day < conf_cases_diff[canton].length; ++day) {
				sum += conf_cases_diff[canton][i + day];
			}
			if (cantons[canton] in inhabitants) {
				sum = sum / inhabitants[cantons[canton]] * 100000;
			}
			else {
				console.log('canton ' + cantons[canton] + ' not found!');
			}
			conf_cases_diff[canton][i] = sum;
			conf_cases_diff[canton].splice(i + 1, avg_days - 1);
		}
		dates.splice(i + 1, avg_days - 1);
	}
}

function updatePlot(dates, districts, new_conf_cases, id){
	var data = [{
		type: 'heatmap',
		x: dates,
		y: districts,
		z: new_conf_cases,
	},
	];

	layout = {
		title: 'Cantonal new confirmed cases over time',
	};

	Plotly.newPlot(id, data, layout);
};

fetchData();

</script>

</body>
</html>
