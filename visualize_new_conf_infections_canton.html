<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="overview" style="width:100%; height:800px;"></div>

<script>

function fetchData() {
 	Plotly.d3.csv('https://raw.githubusercontent.com/openZH/covid_19/master/COVID19_Fallzahlen_CH_total_v2.csv',
		function(data){
			processData(data)
		}
	);
};
	
function processData(rows) {
	let dates = [];
	let cantons = [];

	for (let i = 0; i < rows.length; i++) {
		row = rows[i];
		let date_val = row['date'];
		let date_index = dates.indexOf(date_val);
		if (date_index === -1) {
			date_index = dates.length;
			dates.push(date_val);
		}

		let canton = row['abbreviation_canton_and_fl'];
		let canton_index = cantons.indexOf(canton);
		if (canton_index === -1) {
			canton_index = cantons.length;
			cantons.push(canton);
		}
	}

	let conf_cases = [];
	conf_cases.length = cantons.length;
	for (let i = 0; i < rows.length; i++) {
		row = rows[i];
		let date_val = row['date'];
		let date_index = dates.indexOf(date_val);

		let canton = row['abbreviation_canton_and_fl'];
		let canton_index = cantons.indexOf(canton);

		if (!conf_cases[canton_index]) {
			conf_cases[canton_index] = [];
			conf_cases[canton_index].size = dates.size;
		}

		let conf_case = row['ncumul_conf'];
		conf_cases[canton_index][date_index] = conf_case;
	}

	// fill up missing data
	for (let canton = 0; canton < cantons.length; ++canton) {
		let last_value = conf_cases[canton][0];
		for (let i = 1; i < dates.length; ++i) {
			if (!conf_cases[canton][i]) {
				conf_cases[canton][i] = last_value;
			}
			else {
				last_value = conf_cases[canton][i];
			}
		}
	}

	// create the difference
	conf_cases_diff = [];
	conf_cases_diff.size = conf_cases.size;
	for (let canton = 0; canton < cantons.length; ++canton) {
		conf_cases_diff[canton] = [];
		conf_cases_diff[canton].size = conf_cases[canton].size;
		for (let i = 1; i < dates.length; ++i) {
			conf_cases_diff[canton][i] = conf_cases[canton][i] - conf_cases[canton][i - 1]
		}
	}

	const inhabitants = {
		AG: 678207,
		AR: 55234,
		AI: 16145,
		BL: 288132,
		BS: 194766,
		BE: 1034977,
		FR: 318714,
		GE: 499480,
		GL: 40403,
		GR: 198379,
		JU: 73419,
		LU: 409577,
		NE: 176850,
		NW: 43223,
		OW: 37841,
		SH: 81991,
		SZ: 159165,
		SO: 273194,
		SG: 507697,
		TI: 353343,
		TG: 276472,
		UR: 36433,
		VD: 799145,
		VS: 343955,
		ZH: 1520968,
		ZG: 126837,
		FL: 38114,
	};

	// average it weekly
	const avg_days = 7;
	for (let i = 0; i < dates.length; ++i) {
		for (let canton = 0; canton < cantons.length; ++canton) {
			let sum = 0;
			for (let day = 0; day < avg_days; ++day) {
				sum += conf_cases_diff[canton][i + day];
			}
			if (cantons[canton] in inhabitants) {
				sum = sum / inhabitants[cantons[canton]] * 100000;
			}
			else {
				console.log('canton ' + cantons[canton] + ' not found!');
			}
			conf_cases_diff[canton][i] = sum;
			conf_cases_diff[canton].splice(i + 1, avg_days - 1);
		}
		dates.splice(i + 1, avg_days - 1);
	}

	updatePlot(dates, cantons, conf_cases_diff);
}

function updatePlot(dates, districts, new_conf_cases){
	var data = [{
		type: 'heatmap',
		x: dates,
		y: districts,
		z: new_conf_cases,
	},
	];

	layout = {
		title: 'Cantonal new confirmed cases over time',
	};

	Plotly.newPlot('overview', data, layout);
};

fetchData();

</script>

</body>
</html>
